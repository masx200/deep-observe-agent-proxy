{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["function isArray(a: any): a is any[] {\r\n  return Array.isArray(a);\r\n}\r\n\"use strict\";\r\nconst Reflect = window.Reflect;\r\nconst {\r\n  ownKeys,\r\n  deleteProperty,\r\n  apply,\r\n  construct,\r\n  defineProperty,\r\n  get,\r\n  getOwnPropertyDescriptor,\r\n  getPrototypeOf,\r\n  has,\r\n\r\n  set,\r\n  setPrototypeOf\r\n} = Reflect;\r\nfunction isobject(a: any): boolean {\r\n  return typeof a === \"object\" && a !== null;\r\n}\r\nfunction isfunction(a: any): a is Function {\r\n  return typeof a === \"function\";\r\n}\r\n/* API\r\nfunction deepobserveagent(target: Object | Function, callback: callback): any;\r\n\r\ninterface callback {\r\n  (\r\n    target: Object | Function,\r\n    patharray: Array<any>,\r\n    newvalue: any,\r\n    oldvalue: any\r\n  ): void;\r\n}\r\n\r\n*/\r\ninterface Callback<T extends object | Function | any[]> {\r\n  (target: T, patharray: Array<string>, newvalue: any, oldvalue: any): void;\r\n}\r\nfunction deepobserveaddpath<T extends object | Function | any[]>(\r\n  target: T,\r\n  callback: Callback<T>,\r\n  patharray: Array<string> = [],\r\n  ancestor = target\r\n): T {\r\n  if (\r\n    !isfunction(callback)\r\n\r\n    //typeof callback !== \"function\"\r\n  ) {\r\n    console.error(callback);\r\n    console.error(\"observe callback invalid !\");\r\n    throw Error();\r\n\r\n    //throw Error(\"callback not defined!\");\r\n    // setTimeout(() => {\r\n    // }, 0);\r\n\r\n    // callback(t, k, v);\r\n  }\r\n  if (isfunction(target) || isobject(target)) {\r\n    //\r\n\r\n    let fakeobj: T;\r\n\r\n    if (isArray(target)) {\r\n      fakeobj = [] as T;\r\n      /* VM462:1 Uncaught TypeError: 'getOwnPropertyDescriptor' on proxy: trap returned descriptor for property 'length' that is incompatible with the existing property in the proxy target\r\n    at Function.getOwnPropertyDescriptors (<anonymous>)\r\n    at <anonymous>:1:8 */\r\n    } else if (isfunction(target)) {\r\n      fakeobj = (() => {}) as T;\r\n    } else {\r\n      fakeobj = {} as T;\r\n    }\r\n\r\n    setPrototypeOf(fakeobj, null);\r\n    // return (fakeobj => {\r\n    return new Proxy(fakeobj, {\r\n      defineProperty(t, p, a) {\r\n        callback(\r\n          ancestor,\r\n          [...patharray, String(p)],\r\n          //属性描述符的value或者getter\r\n          has(a, \"value\") ? a.value : isfunction(a.get) ? a.get() : undefined,\r\n          get(target, p)\r\n        );\r\n        return defineProperty(target, p, a);\r\n      },\r\n      deleteProperty(t, p) {\r\n        callback(\r\n          ancestor,\r\n          [...patharray, String(p)],\r\n          undefined,\r\n          get(target, p)\r\n\r\n          //target[p]\r\n        );\r\n        return deleteProperty(target, p);\r\n      },\r\n      ownKeys(/*  t*/) {\r\n        return ownKeys(target);\r\n      },\r\n      has(t, p) {\r\n        return has(target, p);\r\n      },\r\n      getPrototypeOf(/* t */) {\r\n        return getPrototypeOf(target);\r\n      },\r\n      setPrototypeOf(t, v) {\r\n        return setPrototypeOf(target, v);\r\n      },\r\n      construct(t, argumentslist) {\r\n        if (\r\n          isfunction(target)\r\n          //typeof target === \"function\"\r\n        ) {\r\n          return construct(target, argumentslist);\r\n        }\r\n      },\r\n      apply(t, thisarg, argarray) {\r\n        if (\r\n          isfunction(target)\r\n          //typeof target === \"function\"\r\n        ) {\r\n          return apply(target, thisarg, argarray);\r\n        }\r\n      },\r\n      /* TypeError: 'get' on proxy: property 'prototype' is a read-only and non-configurable data property on the proxy target but the proxy did not return its actual value (expected '[object Symbol]' but got '[object Object]') */\r\n      getOwnPropertyDescriptor(t, k) {\r\n        var descripter = getOwnPropertyDescriptor(target, k);\r\n        if (isArray(target) && k === \"length\") {\r\n          return descripter;\r\n        } else {\r\n          if (descripter) {\r\n            descripter.configurable = true;\r\n            return descripter;\r\n          } else {\r\n            return;\r\n          }\r\n        }\r\n      },\r\n      //   return {\r\n      //     ...getOwnPropertyDescriptor(t, k),\r\n      //     ...{ configurable: true, writable: true }\r\n      //   };\r\n      // },\r\n\r\n      /* \r\n          https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor\r\n          如果下列不变量被违反，代理将抛出一个 TypeError：\r\n  \r\n  getOwnPropertyDescriptor 必须返回一个 object 或 undefined。\r\n  如果属性作为目标对象的不可配置的属性存在，则该属性无法报告为不存在。\r\n  如果属性作为目标对象的属性存在，并且目标对象不可扩展，则该属性无法报告为不存在。\r\n  如果属性不存在作为目标对象的属性，并且目标对象不可扩展，则不能将其报告为存在。\r\n  属性不能被报告为不可配置，如果它不作为目标对象的自身属性存在，或者作为目标对象的可配置的属性存在。\r\n  Object.getOwnPropertyDescriptor（target）的结果可以使用 Object.defineProperty 应用于目标对象，也不会抛出异常。 */\r\n\r\n      /* https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/set\r\n  \r\n  如果违背以下的约束条件，proxy会抛出一个TypeError:\r\n  \r\n  若目标属性是不可写及不可配置的，则不能改变它的值。\r\n  如果目标属性没有配置存储方法，即set方法是undefined的，则不能设置它的值。\r\n  在严格模式下，若set方法返回false，则会抛出一个 TypeError 异常。\r\n  */\r\n      set(t, k, v) {\r\n        // console.log(\"set\", [t, k, v]);\r\n        if (\r\n          isfunction(callback)\r\n          //typeof callback === \"function\"\r\n        ) {\r\n          //throw Error(\"callback not defined!\");\r\n          callback(\r\n            ancestor,\r\n            [...patharray, String(k)] /* patharray.concat(k) */,\r\n            v,\r\n            get(target, k)\r\n            // target[k]\r\n          );\r\n        }\r\n\r\n        return set(target, k, v);\r\n        // return true;\r\n        /* Uncaught TypeError: 'set' on proxy: trap returned truish for property 'prototype' which exists in the proxy target as a non-configurable and non-writable data property with a different value */\r\n      },\r\n\r\n      /* \r\n          https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/get\r\n          如果违背了以下的约束，proxy会抛出 TypeError:\r\n  \r\n  如果要访问的目标属性是不可写以及不可配置的，则返回的值必须与该目标属性的值相同。\r\n  如果要访问的目标属性没有配置访问方法，即get方法是undefined的，则返回值必须为undefined。 */\r\n      get(t, k) {\r\n        // console.log(\"get\", [t, k]);\r\n        var value = get(target, k);\r\n        if (isfunction(value) || isobject(value)) {\r\n          // var descripter = getOwnPropertyDescriptor(t, k);\r\n          // /* descripter  可能是undefined */\r\n          // if (\r\n          //   descripter &&\r\n          //   descripter.writable === false &&\r\n          //   descripter.configurable === false\r\n          // ) {\r\n          //   console.warn(\r\n          //     `无法代理此属性!\\n如果要访问的目标属性是不可写以及不可配置的，\\n则返回的值必须与该目标属性的值相同。\\n`,\r\n          //     [t, k, value]\r\n          //   );\r\n          //   return value;\r\n          // } else {\r\n          return deepobserveaddpath(\r\n            value,\r\n            callback,\r\n            [...patharray, String(k)],\r\n            //  patharray.concat(k),\r\n            target\r\n          );\r\n          // }\r\n        } else {\r\n          return value;\r\n        }\r\n      }\r\n    });\r\n    // })(fakeobj);\r\n  } else {\r\n    return target;\r\n  }\r\n}\r\nexport default function observedeepagent<T extends object | Function | any[]>(\r\n  target: T,\r\n  callback: Callback<T>\r\n): T {\r\n  if (\r\n    !isfunction(callback)\r\n    //typeof callback !== \"function\"\r\n  ) {\r\n    console.error(callback);\r\n    console.error(\"observe callback  invalid function !\");\r\n    throw Error();\r\n\r\n    //throw Error(\"callback not defined!\");\r\n    // setTimeout(() => {\r\n    // }, 0);\r\n\r\n    // callback(t, k, v);\r\n  }\r\n  if (\r\n    !isfunction(Proxy)\r\n    //typeof Proxy !== \"function\"\r\n  ) {\r\n    console.error(\"Proxy unsupported!\");\r\n    throw Error();\r\n\r\n    //setTimeout(() => {\r\n\r\n    // }, 0);\r\n    // return target;\r\n  }\r\n\r\n  // else\r\n  if (isfunction(target) || isobject(target)) {\r\n    return deepobserveaddpath(target, callback /*, [], target*/);\r\n  } else {\r\n    return target;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}