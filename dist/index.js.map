{"version":3,"file":"index.js","sources":["../src/deepobserveagent.ts"],"sourcesContent":["\"use strict\";\r\nconst Reflect = window.Reflect;\r\nconst {\r\n  ownKeys,\r\n  deleteProperty,\r\n  apply,\r\n  construct,\r\n  defineProperty,\r\n  get,\r\n  getOwnPropertyDescriptor,\r\n  getPrototypeOf,\r\n  has,\r\n\r\n  set,\r\n  setPrototypeOf\r\n} = Reflect;\r\nfunction isobject(a: any): boolean {\r\n  return typeof a === \"object\" && a !== null;\r\n}\r\nfunction isfunction(a: any): boolean {\r\n  return typeof a === \"function\";\r\n}\r\n/* API\r\nfunction deepobserveagent(target: Object | Function, callback: callback): any;\r\n\r\ninterface callback {\r\n  (\r\n    target: Object | Function,\r\n    patharray: Array<any>,\r\n    newvalue: any,\r\n    oldvalue: any\r\n  ): void;\r\n}\r\n\r\n*/\r\ninterface callback {\r\n  (\r\n    target: Object | Function,\r\n    patharray: Array<any>,\r\n    newvalue: any,\r\n    oldvalue: any\r\n  ): void;\r\n}\r\nfunction deepobserveaddpath(\r\n  target: Object | Function,\r\n  callback: callback,\r\n  patharray: Array<any> = [],\r\n  ancestor: Object | Function = target\r\n): Object | Function {\r\n  if (typeof callback !== \"function\") {\r\n    //throw Error(\"callback not defined!\");\r\n    // setTimeout(() => {\r\n    throw Error(\"observe callback invalid !\");\r\n    // }, 0);\r\n\r\n    // callback(t, k, v);\r\n  }\r\n  if (isfunction(target) || isobject(target)) {\r\n    //\r\n\r\n    let fakeobj: Object | Function;\r\n    if (isobject(target)) {\r\n      fakeobj = {};\r\n    } else {\r\n      fakeobj = () => {};\r\n    }\r\n    setPrototypeOf(fakeobj, null);\r\n    return (fakeobj => {\r\n      // function createfork(target) {\r\n      //   var noneobj;\r\n      //   if (typeof target === \"function\") {\r\n      //     noneobj = function() {};\r\n      //   } else if (typeof target === \"object\") {\r\n      //     noneobj = {};\r\n      //   }\r\n      //   setPrototypeOf(noneobj, null);\r\n      //   if (noneobj.prototype) {\r\n      //     noneobj.prototype = null;\r\n      //   }\r\n      //   const forkhandler = {};\r\n      //   [\r\n      //     \"defineProperty\",\r\n      //     \"deleteProperty\",\r\n      //     \"apply\",\r\n      //     \"construct\",\r\n      //     \"get\",\r\n      //     \"getOwnPropertyDescriptor\",\r\n      //     \"getPrototypeOf\",\r\n      //     \"has\",\r\n      //     \"isExtensible\",\r\n      //     \"ownKeys\",\r\n      //     \"preventExtensions\",\r\n      //     \"set\",\r\n      //     \"setPrototypeOf\"\r\n      //   ].forEach(key => {\r\n      //     forkhandler[key] = function(...args) {\r\n      //       args[0] = target;\r\n      //       return Reflect[key](...args);\r\n      //     };\r\n      //   });\r\n      //   return new Proxy(noneobj, forkhandler);\r\n      // }\r\n\r\n      // const fakeobj = Object.create(null);\r\n      return new Proxy(fakeobj, {\r\n        defineProperty(t, p, a) {\r\n          return defineProperty(target, p, a);\r\n        },\r\n        deleteProperty(t, p) {\r\n          callback(\r\n            ancestor,\r\n            [...patharray, p],\r\n            undefined,\r\n            get(target, p)\r\n\r\n            //target[p]\r\n          );\r\n          return deleteProperty(target, p);\r\n        },\r\n        ownKeys(/*  t*/) {\r\n          return ownKeys(target);\r\n        },\r\n        has(t, p) {\r\n          return has(target, p);\r\n        },\r\n        getPrototypeOf(/* t */) {\r\n          return getPrototypeOf(target);\r\n        },\r\n        setPrototypeOf(t, v) {\r\n          return setPrototypeOf(target, v);\r\n        },\r\n        construct(t, argumentslist) {\r\n          if (typeof target === \"function\") {\r\n            return construct(target, argumentslist);\r\n          }\r\n        },\r\n        apply(t, thisarg, argarray) {\r\n          if (typeof target === \"function\") {\r\n            return apply(target, thisarg, argarray);\r\n          }\r\n        },\r\n        /* TypeError: 'get' on proxy: property 'prototype' is a read-only and non-configurable data property on the proxy target but the proxy did not return its actual value (expected '[object Symbol]' but got '[object Object]') */\r\n        getOwnPropertyDescriptor(t, k) {\r\n          var descripter = getOwnPropertyDescriptor(target, k);\r\n          if (descripter) {\r\n            descripter.configurable = true;\r\n            return descripter;\r\n          } else {\r\n            return;\r\n          }\r\n        },\r\n        //   return {\r\n        //     ...getOwnPropertyDescriptor(t, k),\r\n        //     ...{ configurable: true, writable: true }\r\n        //   };\r\n        // },\r\n\r\n        /* \r\n          https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor\r\n          如果下列不变量被违反，代理将抛出一个 TypeError：\r\n  \r\n  getOwnPropertyDescriptor 必须返回一个 object 或 undefined。\r\n  如果属性作为目标对象的不可配置的属性存在，则该属性无法报告为不存在。\r\n  如果属性作为目标对象的属性存在，并且目标对象不可扩展，则该属性无法报告为不存在。\r\n  如果属性不存在作为目标对象的属性，并且目标对象不可扩展，则不能将其报告为存在。\r\n  属性不能被报告为不可配置，如果它不作为目标对象的自身属性存在，或者作为目标对象的可配置的属性存在。\r\n  Object.getOwnPropertyDescriptor（target）的结果可以使用 Object.defineProperty 应用于目标对象，也不会抛出异常。 */\r\n\r\n        /* https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/set\r\n  \r\n  如果违背以下的约束条件，proxy会抛出一个TypeError:\r\n  \r\n  若目标属性是不可写及不可配置的，则不能改变它的值。\r\n  如果目标属性没有配置存储方法，即set方法是undefined的，则不能设置它的值。\r\n  在严格模式下，若set方法返回false，则会抛出一个 TypeError 异常。\r\n  */\r\n        set(t, k, v) {\r\n          // console.log(\"set\", [t, k, v]);\r\n          if (typeof callback === \"function\") {\r\n            //throw Error(\"callback not defined!\");\r\n            callback(\r\n              ancestor,\r\n              [...patharray, k] /* patharray.concat(k) */,\r\n              v,\r\n              get(target, k)\r\n              // target[k]\r\n            );\r\n          }\r\n\r\n          return set(target, k, v);\r\n          // return true;\r\n          /* Uncaught TypeError: 'set' on proxy: trap returned truish for property 'prototype' which exists in the proxy target as a non-configurable and non-writable data property with a different value */\r\n        },\r\n\r\n        /* \r\n          https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/get\r\n          如果违背了以下的约束，proxy会抛出 TypeError:\r\n  \r\n  如果要访问的目标属性是不可写以及不可配置的，则返回的值必须与该目标属性的值相同。\r\n  如果要访问的目标属性没有配置访问方法，即get方法是undefined的，则返回值必须为undefined。 */\r\n        get(t, k) {\r\n          // console.log(\"get\", [t, k]);\r\n          var value = get(target, k);\r\n          if (isfunction(value) || isobject(value)) {\r\n            // var descripter = getOwnPropertyDescriptor(t, k);\r\n            // /* descripter  可能是undefined */\r\n            // if (\r\n            //   descripter &&\r\n            //   descripter.writable === false &&\r\n            //   descripter.configurable === false\r\n            // ) {\r\n            //   console.warn(\r\n            //     `无法代理此属性!\\n如果要访问的目标属性是不可写以及不可配置的，\\n则返回的值必须与该目标属性的值相同。\\n`,\r\n            //     [t, k, value]\r\n            //   );\r\n            //   return value;\r\n            // } else {\r\n            return deepobserveaddpath(\r\n              value,\r\n              callback,\r\n              [...patharray, k],\r\n              //  patharray.concat(k),\r\n              target\r\n            );\r\n            // }\r\n          } else {\r\n            return value;\r\n          }\r\n        }\r\n      });\r\n    })(fakeobj);\r\n  } else {\r\n    return target;\r\n  }\r\n}\r\nexport default function observedeepagent(\r\n  target: Object | Function,\r\n  callback: callback\r\n): Object | Function {\r\n  if (typeof callback !== \"function\") {\r\n    //throw Error(\"callback not defined!\");\r\n    // setTimeout(() => {\r\n    throw Error(\"observe callback  invalid function \");\r\n    // }, 0);\r\n\r\n    // callback(t, k, v);\r\n  }\r\n  if (typeof Proxy !== \"function\") {\r\n    //setTimeout(() => {\r\n    throw Error(\"Proxy unsupported!\");\r\n    // }, 0);\r\n    // return target;\r\n  }\r\n\r\n  // else\r\n  if (isfunction(target) || isobject(target)) {\r\n    return deepobserveaddpath(target, callback, [], target);\r\n  } else {\r\n    return target;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}